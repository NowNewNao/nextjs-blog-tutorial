---
title: "ブラウザをたちあげてからAmazonのサイト表示までに起こること"
date: "2021-05-02"
---

自分が 1 年ほど前に受けた採用面談では、一言も答えらなかった問い。
まだまだブラッシュアップできるところはあるけれど、
今の時点での理解していることをアップしておきたいと思います。

# 大まかな流れ

ひとまず大まかな流れの説明をします。

- Web ブラウザを立ち上げて、「amazon」 と打ち込み、検索結果をクリック。Web ブラウザは該当の URL を解読し、Web サーバーに依頼するリクエストを作成
- インターネットを介して Web サーバーにリクエストを届けるために、リクエストの内容を電気信号に変換して送信
- リクエストがインターネットにむかう
- リクエストがインターネットを経由して Web サーバーにすすんでいく
- リクエストが Web サーバーに入る前の通過点をいくつか経由して、Web サーバーに到着
- Web サーバーが Web ブラウザからのリクエストに対するレスポンスを送り返す
- Web ブラウザは Web サーバーが送り返したレスポンス内容、Amazon の Web サイトが表示される

それぞれに少し補足説明を足していきます。

# 1_Web ブラウザ

ブラウザで「amazon」「アマゾン」などと打ち込むと、検索結果が表示されます。そこで、https://www.amazon.co.jp に該当する。

検索結果をクリックすると、リンクに埋め込まれた URL がブラウザの URL 欄に入力され、ブラウザが URL を解読する。
URL は「サーバー名」と、サーバー上にあるディレクトリ、ファイル名で構成されている。
URL を解読すると、どのサーバーのどのディレクトリ、どのファイルの情報にアクセスすべきかわかる。

HTTP プロトコルを使用してサーバーにリクエストを送信する。今回の場合は、Amazon.co.jp のトップページを表示するリクエスト。

HTTP のリクエストメッセージをつくったら OS に以来して Web サーバーに向けて送信してもらう。ブラウザは HTTP メッセージをつくる機能をもっているが、送り出す機能はもっていない。

OS に依頼をする際の送信先の指定は、ドメイン名ではなく IP アドレスで行う必要がある。

そこで Web ブラウザは、最寄の DNS サーバーに IP アドレスを問い合わせる。今回の場合だと「www.amazon.co.jpというサーバーのIPアドレスをおしえてくれ」という主旨の問い合わせを行う。DNSサーバーは登録されているドメイン名とIPアドレスの対応表を参照し、IPアドレスを回答してくる。

DNS サーバーは一度問い合わせのあったドメイン名に該当する情報をキャッシュに記録している。そのため、過去に問い合わせのあったドメイン名については、対応表を参照する前にキャッシュ機能を利用してすばやく回答してくれる。

# 2\_データの送信準備

IP アドレスを受け取った OS は、ブラウザからのリクエスト送信依頼を実行していく。

ソケットとよばれるデータの送受信の管のようなものを確率していく。
まずリクエストを送信するクライアント側でソケットをつくり、次にサーバー側のソケットとコネクションを確率する。今回のケースでは TCP というプロトコルが用いられる。TCP はコネクションの確率や終了、維持などの管理を行う。コネクションの確率が不要なやりとりの場合は UDP を用いる。（例: DNS サーバーへの問い合わせなど）

クライアントとサーバーが連絡をとる動作自体は TCP プロトコルの仕様で規程されている。

Three-way Handshake とよばれる 3 回のやりとりによってコネクションが確率する。

1. クライアント 「接続を開始して良いでしょうか？」
2. サーバー 「OK！ こちらかも接続開始して良いでしょうか？
3. クライアント 「OK!」
   (コネクション確率！)

通信にのせるために、リクエストはパケットと呼ばれる細かく分割されたデータになる。
パケットはデータの断片にヘッダーが付属したもの。

ヘッダーには使用するプロトコルの制御情報が含まれている。

今回の場合であれば、リクエストのデータの断片に「TCP ヘッダー」「IP ヘッダー」「MAC ヘッダー」がついている。

# 3\_リクエストがインターネットにむかってすすんでいく

パケットに分割されたリクエストは、一つ一つ独立して動く。
ハブ、ルーターなどの中継機を経て、インターネットにはいり、目的の Web サーバーまですすむ。

# 4\_サーバーに入る前の通過点

サーバーの手前にファイアーウォールという関所のような地点がある。ここで、Web サーバーで動くアプリケーションへのアクセス権があるパケットだけをとおし、そうでないパケットを遮断する。また、サーバーへの負荷を軽減するために、アクセスを均等に割り振るロードバランサーという装置によって行先のサーバーを振り分けられる。同じ役割のサーバーを複数台揃えられている場合もあれば、キャッシュ・サーバーにレスポンスを保存している場合もある。その場合はより高速にレスポンスをかえすことができる。

# 5_Web サーバーに到着。Web ブラウザからのリクエストに対するレスポンスを送り返す。

コネクションが確立した段階で、クライアントからリクエストが送られてくることをサーバー側は認知している。
リクエストのデータはパケットに分割されているので、リクエストのデータに組み直す。
リクエストされているしかるべき処理を行い、レスポンスを返す。レスポンスもリクエストど同様にパケットに分割され、リクエストが送信されてきた経路の逆をたどってクライアント側へかえっていく。

# 6_Web ブラウザは Web サーバーが送り返したレスポンス内容を画面に表示する。

Web サーバーからのレスポンスを細切れのパケットで受け取った OS は、元のひとつのデータのかたまりに組み直し、ブラウザに渡す。

ブラウザは Content-Typet というヘッダーのフィールドを確認して、何の種類のデータを受け取るのか判断し、画像、テキスト、音声、映像など、データの種類に応じたレンダリングを行う。

これで Amazon のサイトが表示されました！
